{% extends "homeparent.html" %}

{% block content %}
<div class="job-details-container">
  <header class="job-header">
    <span class="label-looking-for">Offering To&gt;</span>
    <h1 class="job-title">{{ offer.title }}</h1>
  </header>

  <section class="job-content">
    <p class="job-description">{{ offer.description }}</p>
  </section>
  
  <footer class="job-footer">
    <p class="job-commission">
      {% if offer.on_demand %}
        Commission: RM{{ offer.commission }}
      {% else %}
        Salary Range: RM{{ offer.salary_range }}
      {% endif %}
    </p>
    {% if offer.on_demand %}
      {# For all users, show a "Take" button. If the user is the creator, this button submits immediately and triggers the flash message from the route. #}
      {% if g.user and offer.creator.id == g.user.id %}
        <form id="creatorTakeOfferForm" action="{{ url_for('take_offer', offer_id=offer.id) }}" method="POST" style="display:inline;">
          <button type="submit" class="job-take-button">Take</button>
        </form>
      {% else %}
        <!-- For allowed users, show the modal trigger for payment simulation -->
        <button class="job-take-button" id="openTakeOfferModal">Take</button>
      {% endif %}
    {% else %}
      <button class="job-contact-button">Contact</button>
    {% endif %}
  </footer>
</div>

<!-- Payment Modal for Taking the Offer (only relevant for on‑demand offers and non–creators) -->
<div id="takeOfferModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" id="closeTakeOfferModal">&times;</span>
    <h2>Payment</h2>
    <p>Please scan the QR code below to pay RM{{ offer.commission }}.</p>
    <div class="qr-mock">QR CODE</div>
    <!-- Wrap the "Simulate Payment" button in a form so that a full POST is submitted -->
    <form id="takeOfferForm" action="{{ url_for('take_offer', offer_id=offer.id) }}" method="POST">
      <button type="submit" id="simulatePaymentOffer">Simulate Payment</button>
    </form>
  </div>
</div>

<script>
  // === Modal Controls for Taking an Offer ===
  var takeOfferModal = document.getElementById("takeOfferModal");
  var openTakeOfferModal = document.getElementById("openTakeOfferModal");
  var closeTakeOfferModal = document.getElementById("closeTakeOfferModal");

  if(openTakeOfferModal){ // Only attach if button exists (i.e. user is not the creator)
    openTakeOfferModal.onclick = function() {
      takeOfferModal.style.display = "block";
    };
  }

  if(closeTakeOfferModal){
    closeTakeOfferModal.onclick = function() {
      takeOfferModal.style.display = "none";
    };
  }

  window.onclick = function(event) {
    if (event.target == takeOfferModal) {
      takeOfferModal.style.display = "none";
    }
  };
  // === End Modal Controls ===
</script>
{% endblock %}
