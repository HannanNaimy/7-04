{% extends "homeparent.html" %}

{% block styles %}
.job-post.highlight-border {
  border: 2.5px solid #e53935 !important;
  box-shadow: 0 0 0 2px #e5393533;
}

.form-group input[type="file"] {
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 7px 10px;
  background: #fafafa;
  font-size: 1rem;
  margin-top: 4px;
}
.form-group label {
  font-weight: 500;
  margin-bottom: 4px;
  display: block;
}
{% endblock %}

{% block content %}
<div class="jobs-container">
  <div class="jobs-header" style="display: flex; align-items: center; justify-content: space-between;">
    <h1>Offering To...</h1>
    <div>
      {% if offer_count < 7 %}
        <a href="javascript:void(0)" id="openCreateOfferModal" class="create-post-button">Create Post</a>
      {% else %}
        <a href="/createoffer_disabled" class="create-post-button" title="You have reached the maximum limit of 3 offer listings">Create Post</a>
      {% endif %}
    </div>
  </div>
  <div style="margin-bottom: 18px;">
    <span style="display: block; font-size: 1.08rem; color: #535251; font-style: italic; text-align: left; margin-left: 2px;">
      (Create Post if You Want to Do Something and Earn Money, Take a Post from Others to Pay and Get What The Person is Offering)
    </span>
    <span style="display: block; font-size: 1.08rem; color: #e53935; text-align: left; margin-left: 2px;">
      Posts with red highlights means it's yours
    </span>
  </div>
  
  {% set on_demand_offers = offers | selectattr('on_demand', 'equalto', True) | list %}
  {% set listing_offers = offers | rejectattr('on_demand', 'equalto', True) | list %}

  <!-- Section: Instant Offers -->
  <div class="jobs-listings">
      {% for offer in on_demand_offers %}
      <div class="job-post{% if g.user and offer.creator.username == g.user.username %} highlight-border{% endif %}">
        <h2>{{ offer.title }}</h2>
        <div class="on-demand-tag">Instant</div>
        <p>{{ offer.description }}</p>
        <span class="job-meta">Commission: RM{{ offer.commission }}</span><br>
        <span class="job-meta">
          Posted by:
          <a href="{{ url_for('profile', usr=offer.creator.username) }}">{{ offer.creator.username }}</a>
        </span>
        <a href="{{ url_for('offer_details', offer_id=offer.id) }}">
          <button class="take-button">See Details</button>
        </a>
      </div>
      {% endfor %}
  </div>

  <!-- Section: Negotiate Offers -->
  <div class="jobs-listings">
      {% for offer in listing_offers %}
      <div class="job-post{% if g.user and offer.creator.username == g.user.username %} highlight-border{% endif %}">
        <h2>{{ offer.title }}</h2>
        <div class="listing-tag">Negotiate</div>
        <p>{{ offer.description }}</p>
        <span class="job-meta">Salary Range: RM{{ offer.salary_range }}</span><br>
        <span class="job-meta">
          Posted by:
          <a href="{{ url_for('profile', usr=offer.creator.username) }}">{{ offer.creator.username }}</a>
        </span>
        {% if offer.responder %}
        <span class="job-meta">
          Taken by:
          <a href="{{ url_for('profile', usr=offer.responder.username) }}">{{ offer.responder.username }}</a>
        </span>
        {% endif %}
        <a href="{{ url_for('offer_details', offer_id=offer.id) }}">
          <button class="take-button">See Details</button>
        </a>
      </div>
      {% endfor %}
  </div>
</div>

<!-- Modal for “Create Offer” -->
<div id="createOfferModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>

    <ul class="progress">
      <li id="progress1" class="active">Step 1: Offer Details</li>
    </ul>

    <!-- Create Offer Form -->
    <form id="offerDetailsForm" action="/offeringTo" method="POST" enctype="multipart/form-data">
      <!-- Step 1: Offer Details -->
      <div id="step1">
        <h2>Add Offer Details</h2>
        <div class="toggle-container">
          <span class="toggle-label">Instant</span>
          <label class="switch">
            <input type="checkbox" id="onDemandToggle" name="on_demand">
            <span class="slider"></span>
          </label>
        </div>
        <!-- Picture field at the top -->
        <div class="form-group">
          <label for="picture">Add a picture:</label>
          <input type="file" name="picture" id="picture" accept=".png,.jpg,.jpeg,.gif" />
          <span style="font-size: 0.95em; color: #888;">(max 2MB, PNG/JPG/JPEG/GIF)</span>
        </div>
        <!-- Offer Title Field with enforced prefix -->
        <div class="form-group">
          <label for="offerTitle">Offer Title:</label>
          <input type="text" name="title" id="offerTitle" 
                 value="Offering To " placeholder="Enter offer title" />
        </div>
        <div class="form-group">
          <label for="offerDescription">Offer Description:</label>
          <textarea id="offerDescription" name="description" rows="4" placeholder="Enter offer description"></textarea>
        </div>
        <div class="form-group" id="commissionGroup" style="display: none;">
          <label for="commission">Commission:</label>
          <input type="number" name="commission" id="commission" placeholder="Enter commission cost" />
        </div>

        <div class="form-group salary-range" id="salaryRangeGroup">
          <label for="minSalary">Enter Range of Salary:</label>
          <input type="number" name="min_salary" id="minSalary" placeholder="Minimum salary" />
          <input type="number" name="max_salary" id="maxSalary" placeholder="Maximum salary" />
        </div>

        <button type="button" id="toStep1">Submit Offer Details</button>
      </div>
    </form>
  </div>
</div>

<script>
  // --- Enforce Fixed Prefix "Offering To " in the Offer Title Input ---
  var prefix = "Offering To ";
  var offerTitleInput = document.getElementById("offerTitle");

  // Ensure the input always starts with the prefix.
  if (!offerTitleInput.value.startsWith(prefix)) {
    offerTitleInput.value = prefix;
  }

  offerTitleInput.addEventListener("focus", function() {
    if (!this.value.startsWith(prefix)) {
      this.value = prefix;
    }
    // Move cursor to end
    setTimeout(() => {
      this.selectionStart = this.selectionEnd = this.value.length;
    }, 0);
  });

  offerTitleInput.addEventListener("keydown", function(e) {
    var pos = this.selectionStart;
    // Prevent deletion or left navigation into the prefix area.
    if (pos <= prefix.length && (e.key === "Backspace" || e.key === "ArrowLeft")) {
      e.preventDefault();
    }
  });

  offerTitleInput.addEventListener("paste", function(e) {
    e.preventDefault();
    var pasteData = (e.clipboardData || window.clipboardData).getData("text");
    var currentValue = this.value;
    // Insert paste data after the prefix.
    var newValue = currentValue.slice(0, prefix.length) + pasteData + currentValue.slice(this.selectionEnd);
    this.value = newValue;
    this.selectionStart = this.selectionEnd = this.value.length;
  });
  // --- End Prefix Enforcement ---

  // Modal open/close controls.
  var modal = document.getElementById("createOfferModal");
  var openModalBtn = document.getElementById("openCreateOfferModal");
  var closeBtn = document.getElementsByClassName("close")[0];

  openModalBtn.onclick = function() {
    modal.style.display = "block";
  };
  closeBtn.onclick = function() {
    modal.style.display = "none";
  };
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  };

  // Toggle instant switch controls which fields are shown.
  document.getElementById("onDemandToggle").addEventListener("change", function() {
    if (this.checked) {
      console.log("Instant is ON");
      document.getElementById("commissionGroup").style.display = "block";
      document.getElementById("salaryRangeGroup").style.display = "none";
    } else {
      console.log("Instant is OFF");
      document.getElementById("commissionGroup").style.display = "none";
      document.getElementById("salaryRangeGroup").style.display = "block";
    }
  });

  // When the Submit button is clicked, validate and submit the form immediately.
  document.getElementById("toStep1").addEventListener("click", function() {
    var titleValue = offerTitleInput.value;
    if (titleValue.trim() === "" || titleValue === prefix) {
      alert("Please fill in the offer title (after the prefix).");
      return;
    }
    var description = document.getElementById("offerDescription").value;
    if (description.trim() === "") {
      alert("Please fill in the offer description.");
      return;
    }
    var isOnDemand = document.getElementById("onDemandToggle").checked;
    if (isOnDemand) {
      var commission = document.getElementById("commission").value;
      if (commission.trim() === "") {
        alert("Please fill in the commission cost.");
        return;
      }
    } else {
      var minSalary = document.getElementById("minSalary").value;
      var maxSalary = document.getElementById("maxSalary").value;
      if (minSalary.trim() === "" || maxSalary.trim() === "") {
        alert("Please fill in both the minimum and maximum salary.");
        return;
      }
    }
    
    // Submit the form immediately.
    document.getElementById("offerDetailsForm").submit();
  });
</script>
{% endblock %}
